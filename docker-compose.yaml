# ============================================================
# Docker Compose - Rimba Nusantara Full Stack
# Frontend (React + Nginx) + Backend (Express) + PostgreSQL
# ============================================================
#
# Cara pakai:
#   1. Copy .env.example ke .env dan isi nilai yang dibutuhkan:
#      cp .env.example .env
#
#   2. Jalankan semua service:
#      docker compose up -d --build
#
#   3. Migrasi & seed database (pertama kali):
#      docker compose exec api npm run db:setup
#
#   4. Akses aplikasi:
#      - Frontend:  http://localhost
#      - API:       http://localhost/api (via nginx proxy)
#      - API direct: http://localhost:5000/api
#      - pgAdmin:   http://localhost:8080 (opsional, lihat --profile tools)
#
#   5. Perintah berguna:
#      docker compose logs -f              # Lihat semua log
#      docker compose logs -f frontend     # Log frontend saja
#      docker compose logs -f api          # Log backend saja
#      docker compose logs -f db           # Log database saja
#      docker compose down                 # Stop semua service
#      docker compose down -v              # Stop + hapus volumes (RESET DATA)
#
#   6. pgAdmin (opsional):
#      docker compose --profile tools up -d
# ============================================================

services:
  # ==================== PostgreSQL Database ====================
  db:
    image: postgres:16-alpine
    container_name: yprn-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-@yprn-project}
      POSTGRES_DB: ${POSTGRES_DB:-mycompany}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    volumes:
      # Data persistence
      - pgdata:/var/lib/postgresql/data
      # Auto-run migration.sql saat pertama kali init
      - ./backend/database/migration.sql:/docker-entrypoint-initdb.d/01-migration.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-mycompany}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    networks:
      - yprn-network

  # ==================== Express API Backend ====================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: yprn-api
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:${PORT:-5000}"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-5000}
      # Database -- 'db' = nama service PostgreSQL di atas
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_ENCODED:-%40yprn-project}@db:5432/${POSTGRES_DB:-mycompany}
      # Auth
      JWT_SECRET: ${JWT_SECRET:-2aef9b2e7076a1d186b3820a2b8153c9e4f7d0a8b5c2e1f3d6a9b0c7e8f4a2d1b5c3e7f9a0d2b4c6e8f1a3d5b7c9e0f2a4b6d8e1c3f5a7b9d0e2c4f6a8b1d3}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
    volumes:
      # Persist file uploads
      - uploads:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - yprn-network

  # ==================== React Frontend + Nginx ====================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        # API URL diarahkan ke nginx proxy sendiri (relative)
        # Karena nginx reverse proxy /api/ ke backend,
        # frontend cukup panggil /api tanpa domain
        VITE_API_URL: ${VITE_API_URL:-/api}
    container_name: yprn-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - yprn-network

  # ==================== pgAdmin (Opsional - UI Database) ====================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: yprn-pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-8080}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@yprn.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      db:
        condition: service_healthy
    networks:
      - yprn-network
    profiles:
      - tools

# ==================== Volumes ====================
volumes:
  pgdata:
    driver: local
    name: yprn-pgdata
  uploads:
    driver: local
    name: yprn-uploads
  pgadmin_data:
    driver: local
    name: yprn-pgadmin-data

# ==================== Networks ====================
networks:
  yprn-network:
    driver: bridge
    name: yprn-network
