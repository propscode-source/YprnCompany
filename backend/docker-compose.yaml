# ============================================================
# Docker Compose - Rimba Nusantara Backend
# Express 4 + PostgreSQL 16
# ============================================================
# Cara pakai:
#   docker compose up -d              # Jalankan semua service
#   docker compose up -d --build      # Build ulang + jalankan
#   docker compose logs -f api        # Lihat log backend
#   docker compose logs -f db         # Lihat log database
#   docker compose down               # Stop semua service
#   docker compose down -v            # Stop + hapus volumes (RESET DATA)
#
# Migrasi & Seed (pertama kali):
#   docker compose exec api node scripts/migrate.js
#   docker compose exec api node scripts/seed.js
#   -- atau sekaligus:
#   docker compose exec api npm run db:setup
# ============================================================

services:
  # ==================== PostgreSQL Database ====================
  db:
    image: postgres:16-alpine
    container_name: yprn-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-@yprn-project}
      POSTGRES_DB: ${POSTGRES_DB:-mycompany}
      # Performance tuning untuk development
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    volumes:
      # Data persistence
      - pgdata:/var/lib/postgresql/data
      # Auto-run migration.sql saat pertama kali init
      - ./database/migration.sql:/docker-entrypoint-initdb.d/01-migration.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-mycompany}"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    networks:
      - yprn-network

  # ==================== Express API Backend ====================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: yprn-api
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:${PORT:-5000}"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-5000}
      # Database -- 'db' = nama service PostgreSQL di atas
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_ENCODED:-%40yprn-project}@db:5432/${POSTGRES_DB:-mycompany}
      # Auth
      JWT_SECRET: ${JWT_SECRET:-2aef9b2e7076a1d186b3820a2b8153c9e4f7d0a8b5c2e1f3d6a9b0c7e8f4a2d1b5c3e7f9a0d2b4c6e8f1a3d5b7c9e0f2a4b6d8e1c3f5a7b9d0e2c4f6a8b1d3}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
    volumes:
      # Persist file uploads
      - uploads:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - yprn-network

  # ==================== pgAdmin (Opsional - UI Database) ====================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: yprn-pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-8080}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@yprn.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      db:
        condition: service_healthy
    networks:
      - yprn-network
    profiles:
      - tools

# ==================== Volumes ====================
volumes:
  pgdata:
    driver: local
    name: yprn-pgdata
  uploads:
    driver: local
    name: yprn-uploads
  pgadmin_data:
    driver: local
    name: yprn-pgadmin-data

# ==================== Networks ====================
networks:
  yprn-network:
    driver: bridge
    name: yprn-network
